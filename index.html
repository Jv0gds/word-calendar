<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯åˆ†ç±»å™¨</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="è®°å½•å’Œç®¡ç†æ¯æ—¥å­¦ä¹ çš„å•è¯,ç”¨æ—¥å†å¯è§†åŒ–ä½ çš„å­¦ä¹ è¿›åº¦">
    
    <!-- iOS PWA æ”¯æŒ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å•è¯æ—¥å†">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“š å•è¯åˆ†ç±»ä¸ç®¡ç†</h1>

        <!-- PWA å®‰è£…æç¤º -->
        <div id="installPrompt" class="install-prompt" style="display: none;">
            <p>ğŸ“± å°†åº”ç”¨æ·»åŠ åˆ°ä¸»å±å¹•,éšæ—¶éšåœ°å­¦ä¹ å•è¯!</p>
            <button id="installBtn">ç«‹å³å®‰è£…</button>
            <button id="dismissBtn">ç¨å</button>
        </div>

        <div class="input-area">
            <input 
                type="text" 
                id="wordInput" 
                placeholder="è¾“å…¥å•è¯"
                onkeyup="handleEnter(event)"
            >
            <button onclick="addWord()">æ·»åŠ å•è¯</button>
        </div>

        <button class="view-calendar-btn" onclick="goToCalendarPage()">æŸ¥çœ‹æ—¥å†åˆ†ç±»</button>

        <h2>æ‰€æœ‰å•è¯åˆ—è¡¨ (æŒ‰æ·»åŠ é¡ºåº)</h2>
        <div id="results"></div>
    </div>

    <script src="script.js"></script>
    
    <!-- PWA å®‰è£…å’Œæ›´æ–°é€»è¾‘ -->
    <script>
        // ==========================================
        // 1. æ³¨å†Œ Service Worker
        // ==========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => {
                        console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ');
                        
                        // æ£€æŸ¥æ›´æ–°
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // å‘ç°æ–°ç‰ˆæœ¬
                                    if (confirm('ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬ï¼ç‚¹å‡»ç¡®å®šç«‹å³æ›´æ–°')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => console.log('âŒ Service Worker æ³¨å†Œå¤±è´¥:', err));
            });
            
            // ç›‘å¬ Service Worker æ§åˆ¶å™¨å˜åŒ–
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    window.location.reload();
                    refreshing = true;
                }
            });
        }

        // ==========================================
        // 2. PWA å®‰è£…æç¤ºé€»è¾‘
        // ==========================================
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const dismissBtn = document.getElementById('dismissBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ‹’ç»è¿‡ï¼ˆ24å°æ—¶å†…ä¸å†æ˜¾ç¤ºï¼‰
            const lastDismissed = localStorage.getItem('installPromptDismissed');
            const now = Date.now();
            if (lastDismissed && (now - parseInt(lastDismissed)) < 24 * 60 * 60 * 1000) {
                return; // 24å°æ—¶å†…ä¸æ˜¾ç¤º
            }
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰å®‰è£…æç¤º
            installPrompt.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            console.log(`ç”¨æˆ·é€‰æ‹©: ${outcome}`);
            
            if (outcome === 'accepted') {
                console.log('âœ… ç”¨æˆ·æ¥å—å®‰è£…');
            } else {
                console.log('âŒ ç”¨æˆ·æ‹’ç»å®‰è£…');
            }
            
            deferredPrompt = null;
            installPrompt.style.display = 'none';
        });

        dismissBtn.addEventListener('click', () => {
            installPrompt.style.display = 'none';
            // è®°å½•æ‹’ç»æ—¶é—´
            localStorage.setItem('installPromptDismissed', Date.now().toString());
        });

        // ç›‘å¬å®‰è£…æˆåŠŸäº‹ä»¶
        window.addEventListener('appinstalled', () => {
            console.log('âœ… åº”ç”¨å·²æˆåŠŸå®‰è£…åˆ°ä¸»å±å¹•!');
            installPrompt.style.display = 'none';
            
            // å¯ä»¥æ˜¾ç¤ºæ¬¢è¿æç¤º
            setTimeout(() => {
                alert('ğŸ‰ å®‰è£…æˆåŠŸï¼ç°åœ¨å¯ä»¥åƒä½¿ç”¨åŸç”Ÿåº”ç”¨ä¸€æ ·ä½¿ç”¨å•è¯æ—¥å†äº†ï¼');
            }, 1000);
        });

        // ==========================================
        // 3. ç¦»çº¿çŠ¶æ€æç¤º
        // ==========================================
        window.addEventListener('online', () => {
            console.log('ğŸŒ ç½‘ç»œå·²è¿æ¥');
        });

        window.addEventListener('offline', () => {
            console.log('ğŸ“¡ å½“å‰å¤„äºç¦»çº¿æ¨¡å¼');
            // å¯ä»¥æ˜¾ç¤ºç¦»çº¿æç¤ºï¼ˆå¯é€‰ï¼‰
        });
    </script>
</body>
</html>